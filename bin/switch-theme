#!/usr/bin/env bash
# switch-theme: switch tmux and wezterm color themes
# Usage: switch-theme [theme-name]

THEMES_DIR="$HOME/.config/tmux/themes"
CURRENT="$HOME/.local/state/tmux/current-theme.conf"
CURRENT_NAME="$HOME/.local/state/tmux/current-theme-name"
WEZTERM_BG="$HOME/.config/wezterm/background"

# Theme â†’ WezTerm background color mapping
wezterm_color() {
    case "$1" in
        catppuccin-latte)      echo "#eff1f5" ;;
        catppuccin-frappe)     echo "#303446" ;;
        catppuccin-macchiato)  echo "#24273a" ;;
        catppuccin-mocha)      echo "#1e1e2e" ;;
        tokyonight-night)      echo "#1a1b26" ;;
        tokyonight-moon)       echo "#222436" ;;
        kanagawa-wave)         echo "#1f1f28" ;;
        kanagawa-dragon)       echo "#181616" ;;
        oxocarbon)             echo "#161616" ;;
        gruvbox-dark-hard)     echo "#1d2021" ;;
        gruvbox-dark-medium)   echo "#282828" ;;
        gruvbox-dark-soft)     echo "#32302f" ;;
        gruvbox-light-hard)    echo "#f9f5d7" ;;
        gruvbox-light-medium)  echo "#fbf1c7" ;;
        gruvbox-light-soft)    echo "#f2e5bc" ;;
        vague)                 echo "#1a1a1a" ;;
        *)                     echo "" ;;
    esac
}

if [[ $# -eq 0 ]]; then
    current=$(cat "$CURRENT_NAME" 2>/dev/null || echo "none")
    echo "Current theme: $current"
    echo "Available themes:"
    for f in "$THEMES_DIR"/*.conf; do
        echo "  $(basename "$f" .conf)"
    done
    exit 0
fi

theme="$1"
theme_file="$THEMES_DIR/${theme}.conf"

if [[ ! -f "$theme_file" ]]; then
    echo "Theme '$theme' not found."
    echo "Available: $(ls "$THEMES_DIR" | sed 's/\.conf$//' | tr '\n' ' ')"
    exit 1
fi

# Apply tmux theme
mkdir -p "$(dirname "$CURRENT")"
cp "$theme_file" "$CURRENT"
echo "$theme" > "$CURRENT_NAME"

if [[ -n "${TMUX:-}" ]]; then
    tmux source-file ~/.tmux.conf
fi

# Apply wezterm background
color="$(wezterm_color "$theme")"
if [[ -n "$color" ]]; then
    mkdir -p "$(dirname "$WEZTERM_BG")"
    echo "$color" > "$WEZTERM_BG"

    # In WSL, also write to the Windows filesystem so native WezTerm picks it up
    if grep -qi microsoft /proc/version 2>/dev/null; then
        WIN_HOME="$(wslpath "$(cmd.exe /C 'echo %USERPROFILE%' 2>/dev/null | tr -d '\r')")"
        WIN_BG="$WIN_HOME/.config/wezterm/background"
        mkdir -p "$(dirname "$WIN_BG")"
        echo "$color" > "$WIN_BG"
    fi

    echo "Theme '$theme' applied (tmux + wezterm)."
else
    echo "Theme '$theme' applied (tmux only; no wezterm mapping defined)."
fi
