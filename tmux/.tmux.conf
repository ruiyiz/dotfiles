################################################################################
# Tmux Configuration
################################################################################

#-------------------------------------------------------------------------------
# General Settings
#-------------------------------------------------------------------------------

# Set prefix to Ctrl-Space with Ctrl-A fallback
set -g prefix C-Space
set -g prefix2 C-a
bind C-Space send-prefix

# Reload config
bind q source-file ~/.tmux.conf

# Enable mouse support for modern workflows
set -g mouse on

# Set terminal colors
set -g default-terminal "tmux-256color"
set -ga terminal-overrides ",xterm-256color:Tc"

# Increase scrollback buffer size
set -g history-limit 50000

# Start window and pane numbering at 1 (not 0)
set -g base-index 1
setw -g pane-base-index 1

# Renumber windows when one is closed
set -g renumber-windows on

# Reduce escape time for faster command sequences
set -sg escape-time 0

# Enable focus events for vim/neovim compatibility
set -g focus-events on

# Allow tmux to set system clipboard via OSC 52
set -g set-clipboard on

# Let programs send escape sequences directly to the terminal
set -g allow-passthrough on

# Enable extended keys (CSI u) so apps can distinguish e.g. C-l from C-S-l
set -s extended-keys always
set -as terminal-features 'xterm*:extkeys'

# Forward C-S-l as CSI u to the pane (tmux collapses it to plain C-l otherwise)
bind -n C-S-l send-keys Escape "[108;6u"

# Resize windows based on smallest client viewing that window, not session
setw -g aggressive-resize on

# Switch to another session instead of detaching when a session is destroyed
# set -g detach-on-destroy off

#-------------------------------------------------------------------------------
# Vim-style Navigation
#-------------------------------------------------------------------------------

# Use vim keybindings in copy mode
setw -g mode-keys vi

# Vim-style copy mode bindings
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi y send -X copy-selection-and-cancel

#-------------------------------------------------------------------------------
# Pane Controls
#-------------------------------------------------------------------------------

bind h split-window -h -c "#{pane_current_path}"
bind v split-window -v -c "#{pane_current_path}"
bind x kill-pane

# Smart pane switching with vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|l?n?vim?x?|fzf)(diff)?$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h" "if-shell -F '#{?pane_at_left,0,1}'   'select-pane -L'"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "if-shell -F '#{?pane_at_bottom,0,1}' 'select-pane -D'"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "if-shell -F '#{?pane_at_top,0,1}'    'select-pane -U'"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "if-shell -F '#{?pane_at_right,0,1}'  'select-pane -R'"

bind F if-shell -F '#{==:#{session_name},popup}' \
  { detach-client } \
  { display-popup -d "#{pane_current_path}" -w 80% -h 80% -S "fg=${thm_blue}" -E \
    "tmux new-session -A -s popup -c '#{pane_current_path}'" }

#-------------------------------------------------------------------------------
# Window Controls
#-------------------------------------------------------------------------------

bind r command-prompt -I "#W" "rename-window -- '%%'"
bind c new-window -c "#{pane_current_path}"
bind k kill-window

bind -n M-1 select-window -t 1
bind -n M-2 select-window -t 2
bind -n M-3 select-window -t 3
bind -n M-4 select-window -t 4
bind -n M-5 select-window -t 5
bind -n M-6 select-window -t 6
bind -n M-7 select-window -t 7
bind -n M-8 select-window -t 8
bind -n M-9 select-window -t 9

#-------------------------------------------------------------------------------
# Session Controls
#-------------------------------------------------------------------------------

bind R command-prompt -I "#S" "rename-session -- '%%'"
bind C new-session -c "#{pane_current_path}"
bind K kill-session
bind P switch-client -p
bind N switch-client -n

#-------------------------------------------------------------------------------
# Status Bar
#-------------------------------------------------------------------------------

set -g status-position bottom
set -g status-interval 5
set -g status-justify left

# Clear Claude alert when switching to a window
set-hook -g session-window-changed "set-window-option -u @claude_waiting"

# Load current theme (switch with: tmux-theme <name>)
if-shell "[ -f ~/.config/tmux/current-theme.conf ]" \
  "source-file ~/.config/tmux/current-theme.conf" \
  "source-file ~/.config/tmux/themes/catppuccin-mocha.conf"


