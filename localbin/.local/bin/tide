#!/usr/bin/env bash
# Launch a tmux dev session with configurable layouts.
#
# Usage: tide [-l layout] [dir]
#
# Layouts:
#   default:
#     +--------+--------+
#     |  nvim  |        |
#     |  (60%) | claude |
#     +--------+ (50%)  |
#     |  shell |        |
#     |  (40%) |        |
#     +--------+--------+
#       50%       50%
#
#   3col:
#     +--------+--------+--------+
#     |        |        |        |
#     |  nvim  | claude | shell  |
#     |        |        |        |
#     +--------+--------+--------+
#       30%      40%      30%

set -e

layout="default"

while getopts "l:" opt; do
	case $opt in
	l) layout="$OPTARG" ;;
	*)
		echo "Usage: tide [-l layout] [dir]" >&2
		exit 1
		;;
	esac
done
shift $((OPTIND - 1))

dir="${1:-.}"
dir="$(cd "$dir" && pwd)"
window_name="$(basename "$dir")"

# Sanitize window name (tmux doesn't allow dots in names)
window_name="${window_name//./-}"

# Word lists for random session names
adjectives=(bold calm cool dark deep fast free gold keen live mild pale pure rare slim soft warm wise wild zany)
nouns=(arch bear bolt cave claw dawn dusk fern flux gale hawk isle jade knot lark mesa moth node opal pine reef sage tide vale wolf yarn)

rand_adj() { echo "${adjectives[RANDOM % ${#adjectives[@]}]}"; }
rand_noun() { echo "${nouns[RANDOM % ${#nouns[@]}]}"; }

# Resize panes in a tide 3col window on focus change.
# Usage: _3col_focus <focused_pane_id> <window_id>
_3col_focus() {
	local focused="$1" win="$2"
	local panes=()
	while IFS= read -r p; do panes+=("$p"); done < <(
		tmux list-panes -t "$win" -F "#{pane_left} #{pane_id}" | sort -n | awk '{print $2}'
	)
	[ "${#panes[@]}" -ne 3 ] && return 0
	local left="${panes[0]}" mid="${panes[1]}" right="${panes[2]}"
	if [ "$focused" = "$left" ]; then
		tmux resize-pane -t "$right" -x 25%
		tmux resize-pane -t "$left" -x 50%
		tmux resize-pane -t "$mid" -x 25%
	elif [ "$focused" = "$right" ]; then
		tmux resize-pane -t "$left" -x 25%
		tmux resize-pane -t "$right" -x 50%
		tmux resize-pane -t "$mid" -x 25%
	else
		tmux resize-pane -t "$left" -x 25%
		tmux resize-pane -t "$right" -x 25%
		tmux resize-pane -t "$mid" -x 50%
	fi
}

# Layout functions take two args:
#   $1 = target (window id or session name, for the first split)
#   $2 = pane prefix (e.g. "@42" inside tmux, "session:1" outside)

layout_default() {
	local target="$1" pp="$2"

	tmux split-window -h -t "$target" -c "$dir" -l "50%"
	tmux split-window -v -t "${pp}.1" -c "$dir" -l "40%"

	local repl_pane
	repl_pane=$(tmux display-message -p -t "${pp}.2" "#{pane_id}")
	tmux send-keys -t "${pp}.1" "export TDEV_REPL_PANE='$repl_pane'" Enter

	local nvim_pane_id nvim_sock
	nvim_pane_id=$(tmux display-message -p -t "${pp}.1" "#{pane_id}")
	nvim_sock="/tmp/nvim-tdev-${nvim_pane_id#%}.sock"
	tmux send-keys -t "${pp}.1" 'clear' Enter
	tmux send-keys -t "${pp}.1" "nvim --listen '$nvim_sock'" Enter
	tmux send-keys -t "${pp}.2" 'clear' Enter
	tmux send-keys -t "${pp}.3" "export NVIM_LISTEN_ADDRESS='$nvim_sock'" Enter
	tmux send-keys -t "${pp}.3" 'clear' Enter
	tmux send-keys -t "${pp}.3" 'claude' Enter
	tmux select-pane -t "${pp}.3"
	tmux set-option -w -t "$target" @tide-window 1
}

layout_3col() {
	local target="$1" pp="$2"

	# Split into 30% left / 70% right, then 40% mid / 30% right
	tmux split-window -h -t "$target" -c "$dir" -l "70%"
	tmux split-window -h -t "${pp}.2" -c "$dir" -l "43%"

	local repl_pane
	repl_pane=$(tmux display-message -p -t "${pp}.3" "#{pane_id}")
	tmux send-keys -t "${pp}.1" "export TDEV_REPL_PANE='$repl_pane'" Enter

	local nvim_pane_id nvim_sock
	nvim_pane_id=$(tmux display-message -p -t "${pp}.1" "#{pane_id}")
	nvim_sock="/tmp/nvim-tdev-${nvim_pane_id#%}.sock"
	tmux send-keys -t "${pp}.1" 'clear' Enter
	tmux send-keys -t "${pp}.1" "nvim --listen '$nvim_sock'" Enter
	tmux send-keys -t "${pp}.2" "export NVIM_LISTEN_ADDRESS='$nvim_sock'" Enter
	tmux send-keys -t "${pp}.2" 'clear' Enter
	tmux send-keys -t "${pp}.2" 'claude' Enter
	tmux send-keys -t "${pp}.3" 'clear' Enter
	tmux select-pane -t "${pp}.2"
}

apply_layout() {
	case "$layout" in
	default) layout_default "$@" ;;
	3col) layout_3col "$@" ;;
	*)
		echo "Unknown layout: $layout" >&2
		exit 1
		;;
	esac
}

if [ -n "$TMUX" ]; then
	win=$(tmux new-window -P -n "$window_name" -c "$dir" -F "#{window_id}")
	apply_layout "$win" "$win"
else
	session_name="$(rand_adj)-$(rand_noun)"

	tmux new-session -d -s "$session_name" -n "$window_name" -c "$dir" -x "$(tput cols)" -y "$(tput lines)"
	apply_layout "$session_name" "$session_name:1"
	tmux attach-session -t "$session_name"
fi
