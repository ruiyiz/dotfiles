#!/usr/bin/env bash
# Launch a tmux dev session with 3-pane layout:
#   +----------+--------+
#   |  nvim    |        |
#   |  (60%)   | claude |
#   +----------+ (40%)  |
#   |  shell   |        |
#   |  (40%)   |        |
#   +----------+--------+
#     60%         40%

set -e

dir="${1:-.}"
dir="$(cd "$dir" && pwd)"
session_name="$(basename "$dir")"

# Sanitize session name (tmux doesn't allow dots in names)
session_name="${session_name//./-}"

if [ -n "$TMUX" ]; then
    # Inside tmux: create a new window in the current session
    win=$(tmux new-window -P -n "$session_name" -c "$dir" -F "#{window_id}")

    # Split left/right (60/40)
    tmux split-window -h -t "$win" -c "$dir" -l "40%"

    # Split the left pane top/bottom (60/40)
    tmux split-window -v -t "$win.1" -c "$dir" -l "40%"

    # Capture shell pane ID and pass it to the nvim environment
    repl_pane=$(tmux display-message -p -t "$win.2" "#{pane_id}")
    tmux send-keys -t "$win.1" "export TDEV_REPL_PANE='$repl_pane'" Enter

    # Launch programs
    tmux send-keys -t "$win.1" 'nvim' Enter
    tmux send-keys -t "$win.3" 'claude' Enter

    # Focus the shell pane
    tmux select-pane -t "$win.2"
else
    # Outside tmux: create a new session
    if tmux has-session -t "=$session_name" 2>/dev/null; then
        tmux attach-session -t "=$session_name"
        exit 0
    fi

    tmux new-session -d -s "$session_name" -c "$dir" -x "$(tput cols)" -y "$(tput lines)"

    # Split left/right (60/40)
    tmux split-window -h -t "$session_name" -c "$dir" -l "40%"

    # Split the left pane top/bottom (60/40)
    tmux split-window -v -t "$session_name:1.1" -c "$dir" -l "40%"

    # Capture shell pane ID and pass it to the nvim environment
    repl_pane=$(tmux display-message -p -t "$session_name:1.2" "#{pane_id}")
    tmux send-keys -t "$session_name:1.1" "export TDEV_REPL_PANE='$repl_pane'" Enter

    # Launch programs
    tmux send-keys -t "$session_name:1.1" 'nvim' Enter
    tmux send-keys -t "$session_name:1.3" 'claude' Enter

    # Focus the shell pane
    tmux select-pane -t "$session_name:1.2"

    tmux attach-session -t "$session_name"
fi
